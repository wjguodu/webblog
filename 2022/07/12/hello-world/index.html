<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <script>if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode)) window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href); </script>
    
    
        <link rel="shortcut icon" href="/images/favicon.ico">
    
     
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.2.30/dist/vuetify.min.css" rel="stylesheet">
    
<link rel="stylesheet" href="/css/main.css">

    
    







    
    
          

    
    
    
    
    <title>
        
            ElasticSearch-高阶用法 | Hexo
        
    </title>
    
    
<meta name="generator" content="Hexo 6.2.0"></head>
<body>
    <div id="app">
        <v-app>
            <v-content id="page">
                <v-container fluid>
                    <v-row>
                        <v-col cols="2" class="d-none d-md-block">
                            <div id="sidebar" class="float-right">
    <a href="/" rel="home">
        <v-avatar size=96>
            <img id="logo" src="https://avatars.githubusercontent.com/u/31847433?s=400&amp;v=4">     
        </v-avatar> 
    </a>
    <v-divider></v-divider>
    <div class="mini-menu">
        <v-btn icon href="/">
            <v-icon>home</v-icon>
        </v-btn>
        <v-btn icon href="/categories/">
            <v-icon>folder</v-icon>
        </v-btn>
        <v-btn icon href="/tags/">
            <v-icon>bookmark</v-icon>
        </v-btn>
        <v-btn icon @click="SetNightMode">
            <v-icon>{{ nightMode }}</v-icon>
        </v-btn>
    </div>
    <v-list id="main-menu" class="font-weight-bold" flat>
        
    </v-list>
    <v-divider></v-divider>
    
        <div class="post-toc">
            <a href="/2022/07/12/hello-world/" class="toc-header">Table of Contents</a>
            <div class="toc-content">
                <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#ElasticSearch-%E9%AB%98%E9%98%B6%E7%94%A8%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text">ElasticSearch-高阶用法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E6%98%A0%E5%B0%84Mapping"><span class="toc-number">1.1.</span> <span class="toc-text">文档映射Mapping</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%98%A0%E5%B0%84%EF%BC%9A"><span class="toc-number">1.1.1.</span> <span class="toc-text">动态映射：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%98%A0%E5%B0%84%EF%BC%9A"><span class="toc-number">1.1.2.</span> <span class="toc-text">静态映射：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8Mapping%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.</span> <span class="toc-text">常用Mapping参数配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Index-Template"><span class="toc-number">1.3.</span> <span class="toc-text">Index Template</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lndex-Template%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.</span> <span class="toc-text">lndex Template的工作方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ES%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2Query-DSL"><span class="toc-number">1.5.</span> <span class="toc-text">ES高级查询Query DSL</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89match-all"><span class="toc-number">1.5.1.</span> <span class="toc-text">查询所有match_all</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2form"><span class="toc-number">1.6.</span> <span class="toc-text">分页查询form</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%B1%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2Scroll"><span class="toc-number">1.7.</span> <span class="toc-text">深分页查询Scroll</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%9F%A5%E8%AF%A2multi-match"><span class="toc-number">1.8.</span> <span class="toc-text">多字段查询multi_match</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E8%AF%8D%E6%9F%A5%E8%AF%A2Term"><span class="toc-number">1.9.</span> <span class="toc-text">关键词查询Term</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ES%E4%B8%AD%E7%9A%84%E7%BB%93%E6%9E%84%E5%8C%96%E6%90%9C%E7%B4%A2"><span class="toc-number">1.10.</span> <span class="toc-text">ES中的结构化搜索</span></a></li></ol></li></ol>
            </div>
        </div>
    

    <div id="footer">
        <div class="footer-social">
            
                
                <v-btn icon href="mailto:kb1000fx@gmail.com" target="_blank">
                    <v-icon>fas fa-envelope</v-icon>
                </v-btn>
            
                
                <v-btn icon href="https://github.com/kb1000fx" target="_blank">
                    <v-icon>fab fa-github</v-icon>
                </v-btn>
            
                
                <v-btn icon href="https://steamcommunity.com/profiles/76561198346798163" target="_blank">
                    <v-icon>fab fa-steam</v-icon>
                </v-btn>
            
                
                <v-btn icon href="https://weibo.com/kb1000fx" target="_blank">
                    <v-icon>fab fa-weibo</v-icon>
                </v-btn>
            
        </div>
        <v-divider></v-divider>
        <div class="footer-content">
            
                <span id="busuanzi_container_site_uv" style="display: none;"> 
                    Total Visitors <span id="busuanzi_value_site_uv"></span>
                </span>
                <br>
            
            <span>Theme: <a target="_blank" rel="noopener" href="https://github.com/kb1000fx/hexo-theme-insulin">Insulin</a></span><br>
            <span>Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span><br>
            <span>
                &copy; 2015 - 2022 
                John Doe
            </span>
        </div>
    </div>
</div>

                        </v-col>
                        <v-col cols="12" md="10">
                            <v-row>
  <v-col cols="12" md="8" align-self="end">
    <div id="site-header">
      <div id="site-title">
        <a href="/" rel="home">Hexo</a>
      </div>
      <div id="site-description"></div>
      <div id="mobile-menu" class="d-block d-md-none">
        <v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-inner-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,false)"></v-text-field>
        <div class="mobile-mini-menu">
          <v-btn icon href="/">
              <v-icon>home</v-icon>
          </v-btn>
          <v-btn icon href="/categories/">
              <v-icon>folder</v-icon>
          </v-btn>
          <v-btn icon href="/tags/">
              <v-icon>bookmark</v-icon>
          </v-btn>
          <v-btn icon @click="SetNightMode">
              <v-icon>{{ nightMode }}</v-icon>
          </v-btn>
          
        </div>
      </div>    
    </div>
  </v-col>  
  <v-col cols="4" align-self="end" class="d-none d-md-block">
    <v-col align-self="end">
      <v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,false)"></v-text-field>
    </v-col> 
  </v-col>
</v-row>

                            <v-card class="elevation-2 post-card">
    
    
        <div class="post-header">
  <a class="post-header-title font-weight-medium" href="/2022/07/12/hello-world/">ElasticSearch-高阶用法</a>
  <div class="post-header-meta">   
    <span>
      <v-icon color="">event</v-icon>
      Posted on:&nbsp;2022-07-12
    </span>
    <span>
      <v-icon color="">event_available</v-icon>
      Edited on:&nbsp;2022-07-14
    </span>
    <span>
      <v-icon color="">folder</v-icon>
      In:&nbsp;<a class="category-link" href="/categories/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E4%B9%8B-Es/">搜索引擎之-Es</a>
    </span>
    
    <span>
      <v-icon color="">visibility</v-icon>
      Views:&nbsp;<span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
    </span>
    
  </div>
</div>

    
    
    
    
    <div class="post-content typo">
        <p><img src="https://s3.bmp.ovh/imgs/2022/07/14/8abcabba8ed37cbe.png"></p>
<h3 id="ElasticSearch-高阶用法"><a href="#ElasticSearch-高阶用法" class="headerlink" title="ElasticSearch-高阶用法"></a>ElasticSearch-高阶用法</h3><h4 id="文档映射Mapping"><a href="#文档映射Mapping" class="headerlink" title="文档映射Mapping"></a>文档映射Mapping</h4><p>Mapping类似数据库中的schema的定义，作用如下：</p>
<ul>
<li>定义索引中的字段的名称</li>
<li>定义字段的数据类型，例如字符串，数字，布尔等</li>
<li>字段，倒排索引的相关配置(Analyzer)</li>
</ul>
<p>ES中Mapping映射可以分为动态映射和静态映射。</p>
<h5 id="动态映射："><a href="#动态映射：" class="headerlink" title="动态映射："></a>动态映射：</h5><p>在关系数据库中，需要事先创建数据库，然后在该数据库下创建数据表，并创建表字段、类型、长度、主键等，最后才能基于表插入数据。而Elasticsearch中不需要定义Mapping映射（即关系型数据库的表、字段等），在文档写入Elasticsearch时，会根据文档字段自动识别类型，这种机制称之为动态映射。</p>
<h5 id="静态映射："><a href="#静态映射：" class="headerlink" title="静态映射："></a>静态映射：</h5><p>静态映射是在Elasticsearch中也可以事先定义好映射，包含文档的各字段类型、分词器等，这种方式称之为静态映射。</p>
<p>动态映射（DynamicMapping）的机制，使得我们无需手动定义Mappings，Elasticsearch会自动根据文档信息，推算出字段的类型。但是有时候会推算的不对，例如地理位置信息。当类型如果设置不对时，会导致一些功能无法正常运行，例如Range查询</p>
<p>DynamicMapping类型自动识别：</p>
<p><img src="https://s3.bmp.ovh/imgs/2022/07/14/cf79ff2f30acb394.png"></p>
<p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#删除原索引</span><br><span class="line"><span class="number">2</span> DELETE /user</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span> #创建文档(ES根据数据类型, 会自动创建映射)</span><br><span class="line"><span class="number">5</span> PUT /user/_doc/<span class="number">1</span></span><br><span class="line"><span class="number">6</span> &#123;</span><br><span class="line"><span class="number">7</span> <span class="string">&quot;name&quot;</span>:<span class="string">&quot;fox&quot;</span>,</span><br><span class="line"><span class="number">8</span> <span class="string">&quot;age&quot;</span>:<span class="number">32</span>,</span><br><span class="line"><span class="number">9</span> <span class="string">&quot;address&quot;</span>:<span class="string">&quot;长沙麓谷&quot;</span></span><br><span class="line"><span class="number">10</span> &#125;</span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">12</span> #获取文档映射</span><br><span class="line"><span class="number">13</span> GET /user/_mapping</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://s3.bmp.ovh/imgs/2022/07/14/454d1e8c11689e33.png"></p>
<p><strong>思考：能否后期更改Mapping的字段类型？</strong></p>
<p>两种情况：</p>
<ul>
<li>新增加字段<ul>
<li>dynamic设为true时，一旦有新增字段的文档写入，Mapping 也同时被更新</li>
<li>dynamic设为false，Mapping 不会被更新，新增字段的数据 无法被索引，但是信息会出现在_source中</li>
<li>dynamic设置成strict(严格控制策略)，文档写入失败，抛出异 常</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>true</th>
<th>false</th>
<th>strict</th>
</tr>
</thead>
<tbody><tr>
<td>文档可索引</td>
<td>yes</td>
<td>yes</td>
<td>no</td>
</tr>
<tr>
<td>字段可索引</td>
<td>yes</td>
<td>no</td>
<td>no</td>
</tr>
<tr>
<td>Mapping被更新</td>
<td>yes</td>
<td>no</td>
<td>no</td>
</tr>
</tbody></table>
<ul>
<li>对已有字段，一旦已经有数据写入，就不再支持修改字段定义<ul>
<li>Lucene 实现的倒排索引，一旦生成后，就不允许修改</li>
<li>如果希望改变字段类型，可以利用 reindex API，重建索引</li>
</ul>
</li>
</ul>
<p>原因：</p>
<ul>
<li>如果修改了字段的数据类型，会导致已被索引的数据无法被搜索</li>
<li>但是如果是增加新的字段，就不会有这样的影响</li>
</ul>
<p>测试</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="title class_">PUT</span> /user</span><br><span class="line"><span class="number">2</span> &#123;</span><br><span class="line"><span class="number">3</span> <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line"><span class="number">4</span> <span class="string">&quot;dynamic&quot;</span>: <span class="string">&quot;strict&quot;</span>,</span><br><span class="line"><span class="number">5</span> <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line"><span class="number">6</span> <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line"><span class="number">7</span> <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line"><span class="number">8</span> &#125;,</span><br><span class="line"><span class="number">9</span> <span class="string">&quot;address&quot;</span>: &#123;</span><br><span class="line"><span class="number">10</span> <span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line"><span class="number">11</span> <span class="string">&quot;dynamic&quot;</span>: <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="number">12</span> &#125;</span><br><span class="line"><span class="number">13</span> &#125;</span><br><span class="line"><span class="number">14</span> &#125;</span><br><span class="line"><span class="number">15</span> &#125;</span><br><span class="line"><span class="number">16</span> <span class="comment"># 插入文档报错，原因为age为新增字段,会抛出异常</span></span><br><span class="line"><span class="number">17</span> <span class="title class_">PUT</span> /user/_doc/<span class="number">1</span></span><br><span class="line"><span class="number">18</span> &#123;</span><br><span class="line"><span class="number">19</span> <span class="string">&quot;name&quot;</span><span class="symbol">:<span class="string">&quot;fox&quot;</span></span>,</span><br><span class="line"><span class="number">20</span> <span class="string">&quot;age&quot;</span><span class="symbol">:</span><span class="number">32</span>,</span><br><span class="line"><span class="number">21</span> <span class="string">&quot;address&quot;</span><span class="symbol">:</span>&#123;</span><br><span class="line"><span class="number">22</span> <span class="string">&quot;province&quot;</span><span class="symbol">:<span class="string">&quot;湖南&quot;</span></span>,</span><br><span class="line"><span class="number">23</span> <span class="string">&quot;city&quot;</span><span class="symbol">:<span class="string">&quot;长沙&quot;</span></span></span><br><span class="line"><span class="number">24</span> &#125;</span><br><span class="line"><span class="number">25</span> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>dynamic设置成strict，新增age字段导致文档插入失败</strong></p>
<p><strong>修改dynamic后再次插入文档成功</strong></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="comment">#修改daynamic</span></span><br><span class="line"><span class="number">2</span> <span class="title class_">PUT</span> /user/_mapping</span><br><span class="line"><span class="number">3</span> &#123;</span><br><span class="line"><span class="number">4</span> <span class="string">&quot;dynamic&quot;</span><span class="symbol">:true</span></span><br><span class="line"><span class="number">5</span> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>对已有字段的mapping修改</strong></p>
<p>具体方法：</p>
<ol>
<li>如果要推倒现有的映射, 你得重新建立一个静态索引</li>
<li>然后把之前索引里的数据导入到新的索引里</li>
<li>删除原创建的索引</li>
<li>为新索引起个别名, 为原索引名</li>
</ol>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span> <span class="title class_">PUT</span> /user2</span><br><span class="line"><span class="number">3</span> &#123;</span><br><span class="line"><span class="number">4</span> 	<span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line"><span class="number">5</span> 	<span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line"><span class="number">6</span> 	<span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line"><span class="number">7</span> 	<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line"><span class="number">8</span> &#125;,</span><br><span class="line"><span class="number">9</span> <span class="string">&quot;address&quot;</span>: &#123;</span><br><span class="line"><span class="number">10</span> 	<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line"><span class="number">11</span> 	<span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line"><span class="number">12</span> &#125;</span><br><span class="line"><span class="number">13</span> &#125;</span><br><span class="line"><span class="number">14</span> &#125;</span><br><span class="line"><span class="number">15</span> &#125;</span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="number">17</span> <span class="title class_">POST</span> _reindex</span><br><span class="line"><span class="number">18</span> &#123;</span><br><span class="line"><span class="number">19</span> 	<span class="string">&quot;source&quot;</span>: &#123;</span><br><span class="line"><span class="number">20</span> 	<span class="string">&quot;index&quot;</span>: <span class="string">&quot;user&quot;</span></span><br><span class="line"><span class="number">21</span> &#125;,</span><br><span class="line"><span class="number">22</span> 	<span class="string">&quot;dest&quot;</span>: &#123;</span><br><span class="line"><span class="number">23</span> 	<span class="string">&quot;index&quot;</span>: <span class="string">&quot;user2&quot;</span></span><br><span class="line"><span class="number">24</span> &#125;</span><br><span class="line"><span class="number">25</span> &#125;</span><br><span class="line"><span class="number">26</span></span><br></pre></td></tr></table></figure>

<p><strong>注意: 通过这几个步骤就实现了索引的平滑过渡,并且是零停机</strong></p>
<h4 id="常用Mapping参数配置"><a href="#常用Mapping参数配置" class="headerlink" title="常用Mapping参数配置"></a>常用Mapping参数配置</h4><ul>
<li>index: 控制当前字段是否被索引，默认为true。如果设置为false，该字段不可 被搜索</li>
</ul>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="title class_">DELETE</span> /user</span><br><span class="line"><span class="number">2</span> <span class="title class_">PUT</span> /user</span><br><span class="line"><span class="number">3</span> &#123;</span><br><span class="line"><span class="number">4</span> 		<span class="string">&quot;mappings&quot;</span> : &#123;</span><br><span class="line"><span class="number">5</span> 		<span class="string">&quot;properties&quot;</span> : &#123;</span><br><span class="line"><span class="number">6</span> 		<span class="string">&quot;address&quot;</span> : &#123;</span><br><span class="line"><span class="number">7</span> 		<span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line"><span class="number">8</span> 		<span class="string">&quot;index&quot;</span>: <span class="literal">false</span></span><br><span class="line"><span class="number">9</span> &#125;,</span><br><span class="line"><span class="number">10</span> 		<span class="string">&quot;age&quot;</span> : &#123;</span><br><span class="line"><span class="number">11</span> 		<span class="string">&quot;type&quot;</span> : <span class="string">&quot;long&quot;</span></span><br><span class="line"><span class="number">12</span> 				&#125;,</span><br><span class="line"><span class="number">13</span> 		<span class="string">&quot;name&quot;</span> : &#123;</span><br><span class="line"><span class="number">14</span> 		<span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span></span><br><span class="line"><span class="number">15</span> 				&#125;</span><br><span class="line"><span class="number">16</span> 			&#125;</span><br><span class="line"><span class="number">17</span> 		&#125;</span><br><span class="line"><span class="number">18</span> &#125;</span><br><span class="line"><span class="number">19</span></span><br><span class="line"><span class="number">20</span> <span class="title class_">PUT</span> /user/_doc/<span class="number">1</span></span><br><span class="line"><span class="number">21</span> 	&#123;</span><br><span class="line"><span class="number">22</span> 		<span class="string">&quot;name&quot;</span><span class="symbol">:<span class="string">&quot;fox&quot;</span></span>,</span><br><span class="line"><span class="number">23</span> 		<span class="string">&quot;address&quot;</span><span class="symbol">:<span class="string">&quot;广州白云山公园&quot;</span></span>,</span><br><span class="line"><span class="number">24</span> 		<span class="string">&quot;age&quot;</span><span class="symbol">:</span><span class="number">30</span></span><br><span class="line"><span class="number">25</span> 	&#125;</span><br><span class="line"><span class="number">26</span></span><br><span class="line"><span class="number">27</span> <span class="title class_">GET</span> /user</span><br><span class="line"><span class="number">28</span></span><br><span class="line"><span class="number">29</span> <span class="title class_">GET</span> /user/_search</span><br></pre></td></tr></table></figure>

<p><img src="https://s3.bmp.ovh/imgs/2022/07/14/57dc740f45a6fc50.png"></p>
<ul>
<li>有四种不同基本的index options配置，控制倒排索引记录的内容：<ul>
<li>docs : 记录doc id</li>
<li>freqs：记录doc id 和term frequencies（词频）</li>
<li>positions: 记录doc id &#x2F; term frequencies &#x2F; term position</li>
<li>offsets: doc id &#x2F; term frequencies &#x2F; term posistion &#x2F; character offsets</li>
</ul>
</li>
</ul>
<p><strong>text类型默认记录postions，其他默认为 docs。记录内容越多，占用存储空间越大</strong></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">DELETE</span> /user</span><br><span class="line"><span class="number">2</span> <span class="title class_">PUT</span> /user</span><br><span class="line"><span class="number">3</span> &#123;</span><br><span class="line"><span class="number">4</span> 		<span class="string">&quot;mappings&quot;</span> : &#123;</span><br><span class="line"><span class="number">5</span> 		<span class="string">&quot;properties&quot;</span> : &#123;</span><br><span class="line"><span class="number">6</span> 		<span class="string">&quot;address&quot;</span> : &#123;</span><br><span class="line"><span class="number">7</span> 		<span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line"><span class="number">8</span> 		<span class="string">&quot;index_options&quot;</span>: <span class="string">&quot;offsets&quot;</span></span><br><span class="line"><span class="number">9</span> &#125;,</span><br><span class="line"><span class="number">10</span> 		<span class="string">&quot;age&quot;</span> : &#123;</span><br><span class="line"><span class="number">11</span> 		<span class="string">&quot;type&quot;</span> : <span class="string">&quot;long&quot;</span></span><br><span class="line"><span class="number">12</span> 				&#125;,</span><br><span class="line"><span class="number">13</span> 		<span class="string">&quot;name&quot;</span> : &#123;</span><br><span class="line"><span class="number">14</span> 		<span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span></span><br><span class="line"><span class="number">15</span> 				 &#125;</span><br><span class="line"><span class="number">16</span> &#125;</span><br><span class="line"><span class="number">17</span> &#125;</span><br><span class="line"><span class="number">18</span> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>null_value: 需要对Null值进行搜索，只有keyword类型支持设计Null_Value</strong></p>
<p><img src="https://s3.bmp.ovh/imgs/2022/07/14/0b0e2fd862089b1f.png"></p>
<p><strong>copy_to设置：将字段的数值拷贝到目标字段，满足一些特定的搜索需求。 copy_to的目标字段不出现在_source中。</strong></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="comment"># 设置copy_to</span></span><br><span class="line"><span class="number">2</span> <span class="title class_">DELETE</span> /address</span><br><span class="line"><span class="number">3</span> <span class="title class_">PUT</span> /address</span><br><span class="line"><span class="number">4</span> &#123;</span><br><span class="line"><span class="number">5</span> 		<span class="string">&quot;mappings&quot;</span> : &#123;</span><br><span class="line"><span class="number">6</span> 		<span class="string">&quot;properties&quot;</span> : &#123;</span><br><span class="line"><span class="number">7</span> 		<span class="string">&quot;province&quot;</span> : &#123;</span><br><span class="line"><span class="number">8</span> 		<span class="string">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line"><span class="number">9</span> 		<span class="string">&quot;copy_to&quot;</span>: <span class="string">&quot;full_address&quot;</span></span><br><span class="line"><span class="number">10</span> 	&#125;,</span><br><span class="line"><span class="number">11</span> 		<span class="string">&quot;city&quot;</span> : &#123;</span><br><span class="line"><span class="number">12</span> 		<span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line"><span class="number">13</span> 		<span class="string">&quot;copy_to&quot;</span>: <span class="string">&quot;full_address&quot;</span></span><br><span class="line"><span class="number">14</span>				 &#125;</span><br><span class="line"><span class="number">15</span> 	&#125;</span><br><span class="line"><span class="number">16</span> 	&#125;,</span><br><span class="line"><span class="number">17</span> 		<span class="string">&quot;settings&quot;</span> : &#123;</span><br><span class="line"><span class="number">18</span> 		<span class="string">&quot;index&quot;</span> : &#123;</span><br><span class="line"><span class="number">19</span> 		<span class="string">&quot;analysis.analyzer.default.type&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line"><span class="number">20</span> &#125;</span><br><span class="line"><span class="number">21</span> &#125;</span><br><span class="line"><span class="number">22</span> &#125;</span><br><span class="line"><span class="number">23</span></span><br><span class="line"><span class="number">24</span> <span class="title class_">PUT</span> /address/_bulk</span><br><span class="line"><span class="number">25</span> 			&#123; <span class="string">&quot;index&quot;</span>: &#123; <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>&#125; &#125;</span><br><span class="line"><span class="number">26</span> 			&#123;<span class="string">&quot;province&quot;</span>: <span class="string">&quot;湖南&quot;</span>,<span class="string">&quot;city&quot;</span>: <span class="string">&quot;长沙&quot;</span>&#125;</span><br><span class="line"><span class="number">27</span> 			&#123; <span class="string">&quot;index&quot;</span>: &#123; <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;2&quot;</span>&#125; &#125;</span><br><span class="line"><span class="number">28</span> 			&#123;<span class="string">&quot;province&quot;</span>: <span class="string">&quot;湖南&quot;</span>,<span class="string">&quot;city&quot;</span>: <span class="string">&quot;常德&quot;</span>&#125;</span><br><span class="line"><span class="number">29</span> 			&#123; <span class="string">&quot;index&quot;</span>: &#123; <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;3&quot;</span>&#125; &#125;</span><br><span class="line"><span class="number">30</span> 			&#123;<span class="string">&quot;province&quot;</span>: <span class="string">&quot;广东&quot;</span>,<span class="string">&quot;city&quot;</span>: <span class="string">&quot;广州&quot;</span>&#125;</span><br><span class="line"><span class="number">31</span> 			&#123; <span class="string">&quot;index&quot;</span>: &#123; <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;4&quot;</span>&#125; &#125;</span><br><span class="line"><span class="number">32</span> 			&#123;<span class="string">&quot;province&quot;</span>: <span class="string">&quot;湖南&quot;</span>,<span class="string">&quot;city&quot;</span>: <span class="string">&quot;邵阳&quot;</span>&#125;</span><br><span class="line"><span class="number">33</span></span><br><span class="line"><span class="number">34</span> <span class="title class_">GET</span> /address/_search</span><br><span class="line"><span class="number">35</span> &#123;</span><br><span class="line"><span class="number">36</span> 		<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line"><span class="number">37</span> 		<span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line"><span class="number">38</span> 		<span class="string">&quot;full_address&quot;</span>: &#123;</span><br><span class="line"><span class="number">39</span> 		<span class="string">&quot;query&quot;</span>: <span class="string">&quot;湖南常德&quot;</span>,</span><br><span class="line"><span class="number">40</span> 		<span class="string">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line"><span class="number">41</span> &#125;</span><br><span class="line"><span class="number">42</span> &#125;</span><br><span class="line"><span class="number">43</span> &#125;</span><br><span class="line"><span class="number">44</span> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Index-Template"><a href="#Index-Template" class="headerlink" title="Index Template"></a>Index Template</h4><p>Index Templates可以帮助你设定Mappings和Settings，并按照一定的规则，自动匹配到 新创建的索引之上</p>
<ul>
<li>模版仅在一个索引被新创建时，才会产生作用。修改模版不会影响已创建的索引</li>
<li>你可以设定多个索引模版，这些设置会被“merge”在一起</li>
<li>你可以指定“order”的数值，控制“merging”的过程</li>
</ul>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="title class_">PUT</span> /_template/template_default</span><br><span class="line"><span class="number">2</span> &#123;</span><br><span class="line"><span class="number">3</span> 		<span class="string">&quot;index_patterns&quot;</span>: [<span class="string">&quot;*&quot;</span>],</span><br><span class="line"><span class="number">4</span> 		<span class="string">&quot;order&quot;</span>: <span class="number">0</span>,</span><br><span class="line"><span class="number">5</span> 		<span class="string">&quot;version&quot;</span>: <span class="number">1</span>,</span><br><span class="line"><span class="number">6</span> 		<span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line"><span class="number">7</span> 		<span class="string">&quot;number_of_shards&quot;</span>: <span class="number">1</span>,</span><br><span class="line"><span class="number">8</span> 		<span class="string">&quot;number_of_replicas&quot;</span>: <span class="number">1</span></span><br><span class="line"><span class="number">9</span> &#125;</span><br><span class="line"><span class="number">10</span> &#125;</span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="number">13</span> <span class="title class_">PUT</span> /_template/template_test</span><br><span class="line"><span class="number">14</span> &#123;</span><br><span class="line"><span class="number">15</span> 		<span class="string">&quot;index_patterns&quot;</span>: [<span class="string">&quot;test*&quot;</span>],</span><br><span class="line"><span class="number">16</span> 		<span class="string">&quot;order&quot;</span>: <span class="number">1</span>,</span><br><span class="line"><span class="number">17</span> 		<span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line"><span class="number">18</span> 		<span class="string">&quot;number_of_shards&quot;</span>: <span class="number">2</span>,</span><br><span class="line"><span class="number">19</span> 		<span class="string">&quot;number_of_replicas&quot;</span>: <span class="number">1</span></span><br><span class="line"><span class="number">20</span> &#125;,</span><br><span class="line"><span class="number">21</span> 		<span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line"><span class="number">22</span> 		<span class="string">&quot;date_detection&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="number">23</span> 		<span class="string">&quot;numeric_detection&quot;</span>: <span class="literal">true</span></span><br><span class="line"><span class="number">24</span> &#125;</span><br><span class="line"><span class="number">25</span> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="lndex-Template的工作方式"><a href="#lndex-Template的工作方式" class="headerlink" title="lndex Template的工作方式"></a>lndex Template的工作方式</h4><p>当一个索引被新创建时：</p>
<ul>
<li>应用Elasticsearch 默认的settings 和mappings</li>
<li>应用order数值低的lndex Template 中的设定</li>
<li>应用order高的 Index Template 中的设定，之前的设定会被覆盖</li>
<li>应用创建索引时，用户所指定的Settings和 Mappings，并覆盖之前模版中的设 定</li>
</ul>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="comment">#查看template信息</span></span><br><span class="line"><span class="number">2</span> <span class="title class_">GET</span> /_template/template_default</span><br><span class="line"><span class="number">3</span> <span class="title class_">GET</span> /_template/temp*</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span> <span class="title class_">PUT</span> /testtemplate/_doc/<span class="number">1</span></span><br><span class="line"><span class="number">6</span> &#123;</span><br><span class="line"><span class="number">7</span> 		<span class="string">&quot;orderNo&quot;</span>: <span class="number">1</span>,</span><br><span class="line"><span class="number">8</span> 		<span class="string">&quot;createDate&quot;</span>: <span class="string">&quot;2022/01/01&quot;</span></span><br><span class="line"><span class="number">9</span> &#125;</span><br><span class="line"><span class="number">10</span> <span class="title class_">GET</span> /testtemplate/_mapping</span><br><span class="line"><span class="number">11</span> <span class="title class_">GET</span> /testtemplate/_settings</span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="number">13</span> <span class="title class_">PUT</span> /testmy</span><br><span class="line"><span class="number">14</span> &#123;</span><br><span class="line"><span class="number">15</span> 		<span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line"><span class="number">16</span> 		<span class="string">&quot;date_detection&quot;</span>: <span class="literal">true</span></span><br><span class="line"><span class="number">17</span> &#125;</span><br><span class="line"><span class="number">18</span> &#125;</span><br><span class="line"><span class="number">19</span></span><br><span class="line"><span class="number">20</span> <span class="title class_">PUT</span> /testmy/_doc/<span class="number">1</span></span><br><span class="line"><span class="number">21</span> &#123;</span><br><span class="line"><span class="number">22</span> 		<span class="string">&quot;orderNo&quot;</span>: <span class="number">1</span>,</span><br><span class="line"><span class="number">23</span> 		<span class="string">&quot;createDate&quot;</span>: <span class="string">&quot;2022/01/01&quot;</span></span><br><span class="line"><span class="number">24</span> &#125;</span><br><span class="line"><span class="number">25</span></span><br><span class="line"><span class="number">26</span> <span class="title class_">GET</span> /testmy/_mapping</span><br></pre></td></tr></table></figure>

<p><strong>Dynamic Template</strong></p>
<p>Dynamic Tempate定义在某个索引的Mapping中。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> #Dynaminc Mapping 根据类型和字段名</span><br><span class="line"><span class="number">2</span> DELETE my_index</span><br><span class="line"><span class="number">3</span> PUT my_index/_doc/<span class="number">1</span></span><br><span class="line"><span class="number">4</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> 		<span class="attr">&quot;firstName&quot;</span><span class="punctuation">:</span><span class="string">&quot;Ruan&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">6</span> 		<span class="attr">&quot;isVIP&quot;</span><span class="punctuation">:</span><span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="number">7</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span> GET my_index/_mapping</span><br><span class="line"><span class="number">10</span> DELETE my_index</span><br><span class="line"><span class="number">11</span> PUT my_index</span><br><span class="line"><span class="number">12</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">13</span> 		<span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">14</span> 		<span class="attr">&quot;dynamic_templates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="number">15</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">16</span> 		<span class="attr">&quot;strings_as_boolean&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">17</span> 		<span class="attr">&quot;match_mapping_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">18</span> 		<span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="string">&quot;is*&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">19</span> 		<span class="attr">&quot;mapping&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">20</span> 		<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span></span><br><span class="line"><span class="number">21</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">22</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">23</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">24</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">25</span> 		<span class="attr">&quot;strings_as_keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">26</span> 		<span class="attr">&quot;match_mapping_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">27</span> 		<span class="attr">&quot;mapping&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">28</span> 		<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line"><span class="number">29</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">30</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">31</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">32</span> <span class="punctuation">]</span></span><br><span class="line"><span class="number">33</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">34</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">35</span></span><br><span class="line"><span class="number">36</span> #结合路径</span><br><span class="line"><span class="number">37</span> PUT /my_test_index</span><br><span class="line"><span class="number">38</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">39</span> 		<span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">40</span> 		<span class="attr">&quot;dynamic_templates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="number">41</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">42</span>	    <span class="attr">&quot;full_name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">43</span> 		<span class="attr">&quot;path_match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name.*&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">44</span> 		<span class="attr">&quot;path_unmatch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*.middle&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">45</span> 		<span class="attr">&quot;mapping&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">46</span> 		<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">47</span> 		<span class="attr">&quot;copy_to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;full_name&quot;</span></span><br><span class="line"><span class="number">48</span> 				<span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">49</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">50</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">51</span> <span class="punctuation">]</span></span><br><span class="line"><span class="number">52</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">53</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">54</span></span><br><span class="line"><span class="number">55</span> PUT /my_test_index/_doc/<span class="number">1</span></span><br><span class="line"><span class="number">56</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">57</span> 		<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">58</span> 		<span class="attr">&quot;first&quot;</span><span class="punctuation">:</span> <span class="string">&quot;John&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">59</span> 		<span class="attr">&quot;middle&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Winston&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">60</span> 		<span class="attr">&quot;last&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lennon&quot;</span></span><br><span class="line"><span class="number">61</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">62</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">63</span></span><br><span class="line"><span class="number">64</span></span><br><span class="line"><span class="number">65</span> GET /my_test_index/_search</span><br><span class="line"><span class="number">66</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">67</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">68</span> 		<span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">69</span> 		<span class="attr">&quot;full_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;John&quot;</span></span><br><span class="line"><span class="number">70</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">71</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">72</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="ES高级查询Query-DSL"><a href="#ES高级查询Query-DSL" class="headerlink" title="ES高级查询Query DSL"></a>ES高级查询Query DSL</h4><p>ES中提供了一种强大的检索数据方式,这种检索方式称之为Query DSL（Domain Specified Language） , Query DSL是利用Rest API传递JSON格式的请求体(RequestBody)数据与 ES进行交互，这种方式的丰富查询语法让ES检索变得更强大，更简洁。 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl.html</a></p>
<p>语法:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> GET /es_db/_doc/_search <span class="punctuation">&#123;</span>json请求体数据<span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">2</span> 可以简化为下面写法</span><br><span class="line"><span class="number">3</span> GET /es_db/_search <span class="punctuation">&#123;</span>json请求体数据<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> #无条件查询，默认返回<span class="number">10</span>条数据</span><br><span class="line"><span class="number">2</span> GET /es_db/_search</span><br><span class="line"><span class="number">3</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> 	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> 	<span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">6</span> 			<span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">7</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s3.bmp.ovh/imgs/2022/07/14/5f222b33785118db.png"></p>
<p>示例数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> #指定ik分词器</span><br><span class="line"><span class="number">2</span> PUT /es_db</span><br><span class="line"><span class="number">3</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> <span class="attr">&quot;settings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">6</span> <span class="attr">&quot;analysis.analyzer.default.type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line"><span class="number">7</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">8</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">9</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">11</span> # 创建文档<span class="punctuation">,</span>指定id</span><br><span class="line"><span class="number">12</span> PUT /es_db/_doc/<span class="number">1</span></span><br><span class="line"><span class="number">13</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">14</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">15</span> <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">16</span> <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">25</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">17</span> <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;广州天河公园&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">18</span> <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java developer&quot;</span></span><br><span class="line"><span class="number">19</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">20</span> PUT /es_db/_doc/<span class="number">2</span></span><br><span class="line"><span class="number">21</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">22</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">23</span> <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">24</span> <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">25</span> <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;广州荔湾大厦&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">26</span> <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java assistant&quot;</span></span><br><span class="line"><span class="number">27</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">28</span></span><br><span class="line"><span class="number">29</span> PUT /es_db/_doc/<span class="number">3</span></span><br><span class="line"><span class="number">30</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">31</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;王五&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">32</span> <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">33</span> <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">26</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">34</span> <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;广州白云山公园&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">35</span> <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;php developer&quot;</span></span><br><span class="line"><span class="number">36</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">37</span></span><br><span class="line"><span class="number">38</span> PUT /es_db/_doc/<span class="number">4</span></span><br><span class="line"><span class="number">39</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">40</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;赵六&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">41</span> <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">42</span> <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">43</span> <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;长沙橘子洲&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">44</span> <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;python assistant&quot;</span></span><br><span class="line"><span class="number">45</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">46</span></span><br><span class="line"><span class="number">47</span> PUT /es_db/_doc/<span class="number">5</span></span><br><span class="line"><span class="number">48</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">49</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张龙&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">50</span> <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">51</span> <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">19</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">52</span> <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;长沙麓谷企业广场&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">53</span> <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java architect assistant&quot;</span></span><br><span class="line"><span class="number">54</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">55</span></span><br><span class="line"><span class="number">56</span> PUT /es_db/_doc/<span class="number">6</span></span><br><span class="line"><span class="number">57</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">58</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;赵虎&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">59</span> <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">60</span> <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">32</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">61</span> <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;长沙麓谷兴工国际产业园&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">62</span> <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java architect&quot;</span></span><br><span class="line"><span class="number">63</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="查询所有match-all"><a href="#查询所有match-all" class="headerlink" title="查询所有match_all"></a>查询所有match_all</h5><p>使用match_all，默认只会返回10条数据。 原因：_search查询默认采用的是分页查询，每页记录数size的默认值为10。如果想显示更 多数据，指定size</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> GET /es_db/_search</span><br><span class="line"><span class="number">2</span> 等同于</span><br><span class="line"><span class="number">3</span> GET /es_db/_search</span><br><span class="line"><span class="number">4</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">6</span>		<span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">7</span> 				<span class="punctuation">&#125;</span>，</span><br><span class="line"><span class="number">9</span>		<span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line"><span class="number">8</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>查询结果的窗口太大，from + size的结果必须小于或等于10000，而当前查询结果的窗 口为20000。</li>
<li>可以采用scroll api更高效的请求大量数据集。</li>
<li>查询结果的窗口的限制可以通过参数index.max_result_window进行设置。</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> PUT /es_db/_settings</span><br><span class="line"><span class="number">2</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">3</span> <span class="attr">&quot;index.max_result_window&quot;</span> <span class="punctuation">:</span><span class="string">&quot;20000&quot;</span></span><br><span class="line"><span class="number">4</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">5</span> #修改现有所有的索引，但新增的索引，还是默认的<span class="number">10000</span></span><br><span class="line"><span class="number">6</span> PUT /_all/_settings</span><br><span class="line"><span class="number">7</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">8</span> <span class="attr">&quot;index.max_result_window&quot;</span> <span class="punctuation">:</span><span class="string">&quot;20000&quot;</span></span><br><span class="line"><span class="number">9</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">11</span> #查看所有索引中的index.max_result_window值</span><br><span class="line"><span class="number">12</span> GET /_all/_settings/index.max_result_window</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意：参数index.max_result_window主要用来限制单次查询满足查询条件的结果窗口的 大小，窗口大小由from + size共同决定。不能简单理解成查询返回给调用方的数据量。这 样做主要是为了限制内存的消耗。</p>
<p>比如：from为1000000，size为10，逻辑意义是从满足条件的数据中取1000000到 （1000000 + 10）的记录。这时ES一定要先将（1000000 + 10）的记录（即 result_window）加载到内存中，再进行分页取值的操作。尽管最后我们只取了10条数据返 回给客户端，但ES进程执行查询操作的过程中确需要将（1000000 + 10）的记录都加载到 内存中，可想而知对内存的消耗有多大。这也是ES中不推荐采用（from + size）方式进行 深度分页的原因。</p>
<p>同理，from为0，size为1000000时，ES进程执行查询操作的过程中确需要将1000000 条 记录都加载到内存中再返回给调用方，也会对ES内存造成很大压力。</p>
<h4 id="分页查询form"><a href="#分页查询form" class="headerlink" title="分页查询form"></a>分页查询form</h4><p>from 关键字: 用来指定起始返回位置，和size关键字连用可实现分页效果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> GET /es_db/_search</span><br><span class="line"><span class="number">2</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">3</span> 	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> 	<span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">5</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">6</span>	 <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">7</span>	 <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="number">8</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="深分页查询Scroll"><a href="#深分页查询Scroll" class="headerlink" title="深分页查询Scroll"></a>深分页查询Scroll</h4><p>改动index.max_result_window参数值的大小，只能解决一时的问题，当索引的数据量持 续增长时，在查询全量数据时还是会出现问题。而且会增加ES服务器内存大结果集消耗完 的风险。最佳实践还是根据异常提示中的采用scroll api更高效的请求大量数据集。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> #查询命令中新增scroll=<span class="number">1</span>m<span class="punctuation">,</span>说明采用游标查询，保持游标查询窗口一分钟。</span><br><span class="line"><span class="number">2</span> #这里由于测试数据量不够，所以size值设置为<span class="number">2</span>。</span><br><span class="line"><span class="number">3</span> #实际使用中为了减少游标查询的次数，可以将值适当增大，比如设置为<span class="number">1000</span>。</span><br><span class="line"><span class="number">4</span> GET /es_db/_search?scroll=<span class="number">1</span>m</span><br><span class="line"><span class="number">5</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">6</span> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">7</span> <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="number">8</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询结果：</p>
<p>除了返回前2条记录，还返回了一个游标ID值_scroll_id。</p>
<p>采用游标id查询：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> # scroll_id 的值就是上一个请求中返回的 _scroll_id 的值</span><br><span class="line"><span class="number">2</span> GET /_search/scroll</span><br><span class="line"><span class="number">3</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> <span class="attr">&quot;scroll&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1m&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">5</span> <span class="attr">&quot;scroll_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFmNwcVdjblRxUzVhZXlicG9HeU02bWcAAAAAAABmzRY2YlV3Z0o5VVNTdWJobkE5Z3MtXzJB&quot;</span></span><br><span class="line"><span class="number">6</span> <span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>多次根据scroll_id游标查询，直到没有数据返回则结束查询。采用游标查询索引全量数据， 更安全高效，限制了单次对内存的消耗。</p>
<p>指定字段排序sort 注意：会让得分失效</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> GET /es_db/_search</span><br><span class="line"><span class="number">2</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">3</span> 	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span>	 <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">5</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">6</span> 	<span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="number">7</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">8</span> 	<span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="number">9</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">10</span> <span class="punctuation">]</span></span><br><span class="line"><span class="number">11</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="number">13</span> #排序，分页</span><br><span class="line"><span class="number">14</span> GET /es_db/_search</span><br><span class="line"><span class="number">15</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">16</span> 	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">17</span> 	<span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">18</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">19</span> 	<span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="number">20</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">21</span> 	<span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line"><span class="number">22</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">23</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">24</span> 	<span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">25</span> 	<span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line"><span class="number">26</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>返回指定字段_source</p>
<p> _source 关键字: 是一个数组,在数组中用来指定展示那些字段</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> GET /es_db/_search</span><br><span class="line"><span class="number">2</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">3</span> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">5</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">6</span> <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">,</span><span class="string">&quot;address&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="number">7</span> <span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>match</strong></p>
<p>match在匹配时会对所查找的关键词进行分词，然后按分词匹配查找</p>
<p>match支持以下参数：</p>
<ul>
<li>query : 指定匹配的值</li>
<li>operator : 匹配条件类型<ul>
<li>and : 条件分词后都要匹配</li>
<li>or : 条件分词后有一个匹配即可(默认)</li>
</ul>
</li>
<li>minmum_should_match : 最低匹配度，即条件在倒排索引中最低的匹配度</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> #模糊匹配 match 分词后or的效果</span><br><span class="line"><span class="number">2</span> GET /es_db/_search</span><br><span class="line"><span class="number">3</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> 		<span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">6</span> 		<span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;广州白云山公园&quot;</span></span><br><span class="line"><span class="number">7</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">8</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">9</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">11</span> # 分词后 and的效果</span><br><span class="line"><span class="number">12</span> GET /es_db/_search</span><br><span class="line"><span class="number">13</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">14</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">15</span> 		<span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">16</span> 		<span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">17</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;广州白云山公园&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">18</span> 		<span class="attr">&quot;operator&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AND&quot;</span></span><br><span class="line"><span class="number">19</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">20</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">21</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">22</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">23</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在match中的应用： 当operator参数设置为or时，minnum_should_match参数用来控制 匹配的分词的最少数量。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> # 最少匹配广州，公园两个词</span><br><span class="line"><span class="number">2</span> GET /es_db/_search</span><br><span class="line"><span class="number">3</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> 		<span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">6</span> 		<span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">7</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;广州公园&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">8</span> 		<span class="attr">&quot;minimum_should_match&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="number">9</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">10</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">11</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">12</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>短语查询match_phrase</strong></p>
<p> match_phrase查询分析文本并根据分析的文本创建一个短语查询。match_phrase 会将检 索关键词分词。match_phrase的分词结果必须在被检索字段的分词中都包含，而且顺序必 须相同，而且默认必须都是连续的。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> GET /es_db/_search</span><br><span class="line"><span class="number">2</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">3</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> 		<span class="attr">&quot;match_phrase&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> 		<span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;广州白云山&quot;</span></span><br><span class="line"><span class="number">6</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">7</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">8</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">9</span> GET /es_db/_search</span><br><span class="line"><span class="number">10</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">11</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">12</span> 		<span class="attr">&quot;match_phrase&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">13</span> 		<span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;广州白云&quot;</span></span><br><span class="line"><span class="number">14</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">15</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">16</span> <span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://s3.bmp.ovh/imgs/2022/07/14/59f7a15a0c902946.png"></p>
<p><strong>分析原因：</strong> </p>
<p>先查看广州白云山公园分词结果，可以知道广州和白云不是相邻的词条，中间会隔一个白云 山，而match_phrase匹配的是相邻的词条，所以查询广州白云山有结果，但查询广州白云 没有结果。</p>
<p>如何解决词条间隔的问题？可以借助slop参数，slop参数告诉match_phrase查询词条能够 相隔多远时仍然将文档视为匹配。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> #广州云山分词后相隔为<span class="number">2</span>，可以匹配到结果</span><br><span class="line"><span class="number">2</span> GET /es_db/_search</span><br><span class="line"><span class="number">3</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> 		<span class="attr">&quot;match_phrase&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">6</span> 		<span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">7</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;广州云山&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">8</span> 		<span class="attr">&quot;slop&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="number">9</span> 				   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">10</span> 				<span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">11</span> 		<span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">12</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">13</span></span><br></pre></td></tr></table></figure>

<h4 id="多字段查询multi-match"><a href="#多字段查询multi-match" class="headerlink" title="多字段查询multi_match"></a>多字段查询multi_match</h4><p><strong>可以根据字段类型，决定是否使用分词查询，得分最高的在前面</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> GET /es_db/_search</span><br><span class="line"><span class="number">2</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">3</span> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;长沙张龙&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">6</span> <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="number">7</span> <span class="string">&quot;address&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">8</span> <span class="string">&quot;name&quot;</span></span><br><span class="line"><span class="number">9</span> <span class="punctuation">]</span></span><br><span class="line"><span class="number">10</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">11</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">12</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>注意：字段类型分词,将查询条件分词之后进行查询，如果该字段不分词就会将查询条件作 为整体进行查询</p>
<p><strong>query_string</strong></p>
<p>允许我们在单个查询字符串中指定AND | OR | NOT条件，同时也和 multi_match query 一样，支持多字段搜索。和match类似，但是match需要指定字段名，query_string是在所 有字段中搜索，范围更广泛。</p>
<p>注意: 查询字段分词就将查询条件分词查询，查询字段不分词将查询条件不分词查询</p>
<p><strong>未指定字段查询</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> GET /es_db/_search</span><br><span class="line"><span class="number">2</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">3</span> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> <span class="attr">&quot;query_string&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三 OR 橘子洲&quot;</span></span><br><span class="line"><span class="number">6</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">7</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">8</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>指定单个字段查询</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> #Query String</span><br><span class="line"><span class="number">2</span> GET /es_db/_search</span><br><span class="line"><span class="number">3</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> <span class="attr">&quot;query_string&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">6</span> <span class="attr">&quot;default_field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;address&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">7</span> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;白云山 OR 橘子洲&quot;</span></span><br><span class="line"><span class="number">8</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">9</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">10</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>指定多个字段查询</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> GET /es_db/_search</span><br><span class="line"><span class="number">2</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">3</span> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> <span class="attr">&quot;query_string&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">,</span><span class="string">&quot;address&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">6</span> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三 OR (广州 AND 王五)&quot;</span></span><br><span class="line"><span class="number">7</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">8</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">9</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">10</span></span><br></pre></td></tr></table></figure>

<p><strong>simple_query_string</strong></p>
<p>类似Query String，但是会忽略错误的语法,同时只支持部分查询语法，不支持AND OR NOT，会当作字符串处理。支持部分逻辑：</p>
<ul>
<li>+ 替代AND</li>
<li>| 替代OR</li>
<li>- 替代NOT</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> #simple_query_string 默认的operator是OR</span><br><span class="line"><span class="number">2</span> GET /es_db/_search</span><br><span class="line"><span class="number">3</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> 	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> 	<span class="attr">&quot;simple_query_string&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">6</span> 	<span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">,</span><span class="string">&quot;address&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">7</span> 	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;广州公园&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">8</span> 	<span class="attr">&quot;default_operator&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AND&quot;</span></span><br><span class="line"><span class="number">9</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">10</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">11</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="number">13</span> GET /es_db/_search</span><br><span class="line"><span class="number">14</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">15</span> 	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">16</span> 	<span class="attr">&quot;simple_query_string&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">17</span> 	<span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">,</span><span class="string">&quot;address&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">18</span> 	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;广州 + 公园&quot;</span></span><br><span class="line"><span class="number">19</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">20</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">21</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="关键词查询Term"><a href="#关键词查询Term" class="headerlink" title="关键词查询Term"></a>关键词查询Term</h4><p>Term用来使用关键词查询(精确匹配),还可以用来查询没有被进行分词的数据类型。Term是 表达语意的最小单位，搜索和利用统计语言模型进行自然语言处理都需要处理Term。 match在匹配时会对所查找的关键词进行分词，然后按分词匹配查找，而term会直接对关 键词进行查找。一般模糊查找的时候，多用match，而精确查找时可以使用term。</p>
<ul>
<li>ES中默认使用分词器为标准分词器(StandardAnalyzer),标准分词器对于英文单 词分词,对于中文单字分词。</li>
<li>在ES的Mapping Type 中 keyword , date ,integer, long , double , boolean or ip 这些类型不分词，只有text类型分词。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> #关键字查询 term</span><br><span class="line"><span class="number">2</span> # 思考： 查询广州白云是否有数据，为什么？</span><br><span class="line"><span class="number">3</span> GET /es_db/_search</span><br><span class="line"><span class="number">4</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">6</span> <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">7</span> <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">8</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;广州白云&quot;</span></span><br><span class="line"><span class="number">9</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">10</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">11</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">12</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">14</span> # 采用term精确查询<span class="punctuation">,</span> 查询字段映射类型为keyword</span><br><span class="line"><span class="number">15</span> GET /es_db/_search</span><br><span class="line"><span class="number">16</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">17</span> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">18</span> <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">19</span> <span class="attr">&quot;address.keyword&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">20</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;广州白云山公园&quot;</span></span><br><span class="line"><span class="number">21</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">22</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">23</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">24</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在ES中，Term查询，对输入不做分词。会将输入作为一个整体，在倒排索引中查找准确的 词项，并且使用相关度算分公式为每个包含该词项的文档进行相关度算分。</p>
<h4 id="ES中的结构化搜索"><a href="#ES中的结构化搜索" class="headerlink" title="ES中的结构化搜索"></a>ES中的结构化搜索</h4><p>结构化搜索(Structured search)是指对结构化数据的搜索。</p>
<p><strong>结构化数据：</strong></p>
<ul>
<li>日期，布尔类型和数字都是结构化的</li>
<li>文本也可以是结构化的。<ul>
<li>如彩色笔可以有离散的颜色集合：红(red) 、绿(green、蓝 (blue)</li>
<li>一个博客可能被标记了标签，例如，分布式(distributed)和搜 索(search)</li>
<li>电商网站上的商品都有UPC(通用产品码Universal Product Code)或其他的唯一</li>
</ul>
</li>
</ul>
<p>标识，它们都需要遵从严格规定的、结构化的格式。</p>
<p>应用场景：对bool，日期，数字，结构化的文本可以利用term做精确匹配</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> GET /es_db/_search</span><br><span class="line"><span class="number">2</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">3</span> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">6</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">28</span></span><br><span class="line"><span class="number">7</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">8</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">9</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">10</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>term处理多值字段，term查询是包含，不是等于</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> POST /employee/_bulk</span><br><span class="line"><span class="number">2</span> <span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">3</span> <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;小明&quot;</span><span class="punctuation">,</span><span class="attr">&quot;interest&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;跑步&quot;</span><span class="punctuation">,</span><span class="string">&quot;篮球&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">4</span> <span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">5</span> <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;小红&quot;</span><span class="punctuation">,</span><span class="attr">&quot;interest&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;跳舞&quot;</span><span class="punctuation">,</span><span class="string">&quot;画画&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">6</span> <span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">7</span> <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;小丽&quot;</span><span class="punctuation">,</span><span class="attr">&quot;interest&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;跳舞&quot;</span><span class="punctuation">,</span><span class="string">&quot;唱歌&quot;</span><span class="punctuation">,</span><span class="string">&quot;跑步&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span> POST /employee/_search</span><br><span class="line"><span class="number">10</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">11</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">12</span> 		<span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">13</span> 		<span class="attr">&quot;interest.keyword&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">14</span> 		<span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;跑步&quot;</span></span><br><span class="line"><span class="number">15</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">16</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">17</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">18</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>前缀查询prefix</strong></p>
<p>它会对分词后的term进行前缀搜索。</p>
<ul>
<li>它不会分析要搜索字符串，传入的前缀就是想要查找的前缀</li>
<li>默认状态下，前缀查询不做相关度分数计算，它只是将所有匹配的文档返回，然 后赋予所有相关分数值为1。它的行为更像是一个过滤器而不是查询。两者实际的区 别就是过滤器是可以被缓存的，而前缀查询不行</li>
</ul>
<p>prefix的原理：需要遍历所有倒排索引，并比较每个term是否已所指定的前缀开头。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> GET /es_db/_search</span><br><span class="line"><span class="number">2</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">3</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> 		<span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> 		<span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">6</span> 		<span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;广州&quot;</span></span><br><span class="line"><span class="number">7</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">8</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">9</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">10</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>通配符查询wildcard</strong></p>
<p>通配符查询：工作原理和prefix相同，只不过它不是只比较开头，它能支持更为复杂的匹配 模式。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> GET /es_db/_search</span><br><span class="line"><span class="number">2</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">3</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> 		<span class="attr">&quot;wildcard&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> 		<span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">6</span> 		<span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*白*&quot;</span></span><br><span class="line"><span class="number">7</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">8</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">9</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">10</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>范围查询range</strong></p>
<ul>
<li>range：范围关键字</li>
<li>gte 大于等于</li>
<li>lte 小于等于</li>
<li>gt 大于</li>
<li>lt 小于</li>
<li>now 当前时间</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> POST /es_db/_search</span><br><span class="line"><span class="number">2</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">3</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> 		<span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> 		<span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">6</span> 		<span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="number">25</span><span class="punctuation">,</span></span><br><span class="line"><span class="number">7</span> 		<span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="number">28</span></span><br><span class="line"><span class="number">8</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">9</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">10</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">11</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>日期range</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> DELETE /product</span><br><span class="line"><span class="number">2</span> POST /product/_bulk</span><br><span class="line"><span class="number">3</span> <span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">4</span> <span class="punctuation">&#123;</span><span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">100</span><span class="punctuation">,</span><span class="attr">&quot;date&quot;</span><span class="punctuation">:</span><span class="string">&quot;2021‐01‐01&quot;</span><span class="punctuation">,</span><span class="attr">&quot;productId&quot;</span><span class="punctuation">:</span><span class="string">&quot;XHDK‐1293&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">5</span> <span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">6</span> <span class="punctuation">&#123;</span><span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">200</span><span class="punctuation">,</span><span class="attr">&quot;date&quot;</span><span class="punctuation">:</span><span class="string">&quot;2022‐01‐01&quot;</span><span class="punctuation">,</span><span class="attr">&quot;productId&quot;</span><span class="punctuation">:</span><span class="string">&quot;KDKE‐5421&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span> GET /product/_mapping</span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">10</span> GET /product/_search</span><br><span class="line"><span class="number">11</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">12</span> 		<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">13</span> 		<span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">14</span> 		<span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">15</span> 		<span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;now‐2y&quot;</span></span><br><span class="line"><span class="number">16</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">17</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">18</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">19</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>多id查询ids</strong></p>
<p>ids 关键字 : 值为数组类型,用来根据一组id获取多个对应的文档</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> GET /es_db/_search</span><br><span class="line"><span class="number">2</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">3</span> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">4</span> <span class="attr">&quot;ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="number">5</span> <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">]</span></span><br><span class="line"><span class="number">6</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">7</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">8</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>模糊查询fuzzy</strong></p>
<p>在实际的搜索中，我们有时候会打错字，从而导致搜索不到。在Elasticsearch中，我们可以 使用fuzziness属性来进行模糊查询，从而达到搜索有错别字的情形。 fuzzy 查询会用到两个很重要的参数，fuzziness，prefix_length</p>
<p><strong>高亮highlight</strong></p>
<p>highlight 关键字: 可以让符合条件的文档中的关键词高亮。</p>
<p>highlight相关属性：</p>
<ul>
<li>pre_tags 前缀标签</li>
<li>post_tags 后缀标签</li>
<li>tags_schema 设置为styled可以使用内置高亮样式</li>
<li>require_field_match 多字段高亮需要设置为false</li>
</ul>

    </div>
    <!--文末结束语-->
    
        <div style="text-align:center;color: #ccc;font-size:24px;"> --- 本文结束 <i class="fas fa-heart"></i> The End --- </div>
    
    <!--页脚广告-->
    
    <v-divider></v-divider>
    
    <div class="post-nav">             
        
            <div class="post-nav-button float-left">
                <v-icon>chevron_left</v-icon>
                <a class="font-weight-bold text-left" href="/2022/07/12/ElasticSearch-%E9%AB%98%E9%98%B6%E7%94%A8%E6%B3%95/">
                    ElasticSearch-高阶用法
                </a>
            </div>
              
        
    </div>
</v-card>



        
                            <div id="mobile-footer" class="d-block d-md-none">
                                <v-divider></v-divider>
                                <div id="mobile-footer-content">
                                    <span>Theme: <a target="_blank" rel="noopener" href="https://github.com/kb1000fx/hexo-theme-insulin">Insulin</a> &nbsp; Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span><br>
                                    <span> &copy; 2015 - 2022 John Doe</span>
                                </div>
                            </div>                   
                        </v-col>                                            
                    </v-row>
                </v-container>
            </v-content>
        </v-app>
    </div>
    
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.2.30"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-base64@3.5.2/base64.min.js"></script>

<script src="/js/main.js"></script>




    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({
        startOnLoad: true,
        theme: "default"
    });</script>





</body>
</html>